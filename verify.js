const crypto=require('crypto');const nodemailer=require('nodemailer');const {PDFDocument,rgb,StandardFonts}=require('pdf-lib');
async function buildInvoicePDF({bookingData,payment}){const pdfDoc=await PDFDocument.create();const page=pdfDoc.addPage([595,842]);const {width}=page.getSize();const font=await pdfDoc.embedFont(StandardFonts.Helvetica);const bold=await pdfDoc.embedFont(StandardFonts.HelveticaBold);const gold=rgb(0.85,0.66,0.25);page.drawRectangle({x:0,y:780,width,height:40,color:rgb(0,0,0)});page.drawText('Mahadev Photography',{x:24,y:790,size:18,font:bold,color:gold});page.drawText('Advance Payment Invoice',{x:24,y:750,size:16,font:bold,color:rgb(0,0,0)});let y=720;const line=(label,value)=>{page.drawText(label,{x:24,y,size:12,font:bold});page.drawText(String(value||''),{x:160,y,size:12,font});y-=18;};line('Name:',bookingData.name);line('Email:',bookingData.email);line('Phone:',bookingData.phone);line('Address:',bookingData.address);y-=8;page.drawText('Booking Details',{x:24,y,size:13,font:bold,color:gold});y-=20;line('Package:',bookingData.package);line('Advance %:',bookingData.advance+'%');y-=8;page.drawText('Events:',{x:24,y,size:12,font:bold});y-=16;(bookingData.events||[]).forEach((e,i)=>{page.drawText(`• ${e.date} – ${e.name}`,{x:32,y:y-i*16,size:12,font});});y-=((bookingData.events||[]).length*16)+12;const grossText=String(bookingData.totalGross||'');line('Total (gross):',grossText);y-=6;page.drawRectangle({x:20,y:y-34,width:width-40,height:40,color:rgb(0.97,0.97,0.97)});page.drawText(`Paid Now: ₹${Number(payment.payNowAmount||0)}`,{x:28,y:y-12,size:13,font:bold});const m=grossText.match(/₹(\d+)/);const grossAmount=m?Number(m[1]):Number(bookingData.packageAmount||0);const due=Math.max(0,grossAmount-Number(payment.payNowAmount||0));page.drawText(`Due: ₹${due}`,{x:220,y:y-12,size:13,font:bold});y-=56;page.drawText('Thank you for your booking!',{x:24,y,size:12,font});y-=18;page.drawText('Pay remaining due anytime via your personal link (contact studio).',{x:24,y,size:11,font});const pdfBytes=await pdfDoc.save();return pdfBytes;}
module.exports=async (req,res)=>{if(req.method!=='POST')return res.status(405).json({error:'Method not allowed'});try{const {razorpay_order_id,razorpay_payment_id,razorpay_signature,bookingData,payNowAmount}=req.body||{};const sign=razorpay_order_id+'|'+razorpay_payment_id;const expected=crypto.createHmac('sha256',process.env.RAZORPAY_KEY_SECRET).update(sign.toString()).digest('hex');if(razorpay_signature!==expected)return res.status(400).json({success:false,message:'Invalid payment signature'});const pdf=await buildInvoicePDF({bookingData,payment:{payNowAmount}});if(process.env.GMAIL_USER&&process.env.GMAIL_PASS){const transporter=nodemailer.createTransport({service:'gmail',auth:{user:process.env.GMAIL_USER,pass:process.env.GMAIL_PASS}});await transporter.sendMail({from:`"Mahadev Photography" <${process.env.GMAIL_USER}>`,to:bookingData?.email,bcc:process.env.GMAIL_USER,subject:'Your Booking Invoice',text:'Thank you for your advance payment. Invoice attached.',attachments:[{filename:'invoice.pdf',content:Buffer.from(pdf)}]});}
if(process.env.SHEET_WEBHOOK_URL){try{await fetch(process.env.SHEET_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...bookingData,payment_id:razorpay_payment_id,pay_now:payNowAmount})});}catch(e){console.error('sheet webhook error',e);}}
return res.status(200).json({success:true});}catch(e){console.error('verify error',e);return res.status(500).json({success:false,error:'Internal error'});}};